# 计划执行状态管理改进说明

## 问题
计划触发后，步骤状态更新有时正确有时不正确。

## 根本原因
1. AI可能跨步骤执行，导致状态混乱
2. 异常情况下状态更新可能被跳过
3. 提示词约束不够强硬
4. 缺少禁止工具调用的检测机制

## 解决方案

### 1. 强化执行提示词 ✅

**位置**: `src/app/api/chat/route.ts` (832-870行, 974-1012行)

**改进内容**:
- 使用 "MANDATORY"、"ABSOLUTE"、"FORBIDDEN" 等强烈词汇
- 结构化为4个绝对规则 (RULE 1-4)
- 明确告知AI：系统自动管理状态，AI禁止调用 progress 工具
- 添加执行前验证清单
- 使用emoji标识关键信息

**效果**: AI更清楚地理解只能执行当前步骤，不得越界

### 2. 保证状态必定更新 ✅

**位置**: `src/app/api/chat/route.ts` (391-560行)

**改进内容**:
```typescript
// 改进前: 多个返回点，可能跳过状态更新
const runStep = async () => {
  writeStepStatus("in_progress");
  if (error) return { status: "failed" }; // ⚠️ 可能跳过
  writeStepStatus("completed");
}

// 改进后: 统一出口，保证状态更新
const runStep = async () => {
  writeStepStatus("in_progress");
  let finalStatus = "completed";
  
  try {
    // ... 所有逻辑
  } catch (error) {
    finalStatus = "failed";
  }
  
  // ✅ 必定执行
  writeStepStatus(finalStatus);
  return { status: finalStatus };
}
```

**新增功能**:
- ✅ 检测禁止工具调用（outline/plan/progress）
- ✅ 全局 try-catch 捕获所有异常
- ✅ 详细日志记录（带emoji）
- ✅ 统一出口保证状态更新

### 3. 增强状态写入函数 ✅

**位置**: `src/app/api/chat/route.ts` (273-378行)

**改进内容**:
- 记录每次状态转换日志
- 检测异常状态转换并警告
- 清理其他进行中的步骤
- 记录步骤执行时长
- Plan不存在时立即报错

**日志示例**:
```
[Plan] ⏳ Step 1/5 starting: plan=abc
[Plan] 📊 Status transition: Step 1 pending → in_progress
[Plan] ✅ Step 1 completed in 5.67s
[Plan] 📈 Progress update emitted: step=1/5, status=completed
```

### 4. 更新计划生成提示词 ✅

**位置**: `src/lib/ai/prompts/plan-prompts.ts`

**改进内容**:
在计划生成阶段明确告知AI:
- 你只需要创建计划结构
- 不要执行任何步骤
- 系统会自动执行和追踪进度
- 不要在计划中描述如何更新状态

## 技术保证

### 状态更新保证
✅ 每个步骤必定: `pending` → `in_progress` → `completed/failed/aborted`  
✅ 状态转换必定被记录和发送到客户端  
✅ 异常情况必定被捕获并标记为 failed  

### 单步执行保证
✅ 强硬的系统提示词约束  
✅ 检测并阻止禁止工具调用  
✅ 详细日志记录步骤边界  

## 改进文件清单

| 文件 | 改动内容 | 行数 |
|------|---------|------|
| `src/app/api/chat/route.ts` | 强化outline执行提示词 | 832-870 |
| `src/app/api/chat/route.ts` | 强化plan执行提示词 | 974-1012 |
| `src/app/api/chat/route.ts` | 重构runStep函数 | 391-560 |
| `src/app/api/chat/route.ts` | 增强writeStepStatus函数 | 273-378 |
| `src/lib/ai/prompts/plan-prompts.ts` | 更新OUTLINE_GENERATION_PROMPT | 20-74 |
| `src/lib/ai/prompts/plan-prompts.ts` | 更新PLAN_GENERATION_PROMPT | 82-118 |

## 测试建议

### 必测场景
1. ✅ **正常流程**: 3-5步计划，全部成功
2. ✅ **中途失败**: 某步骤失败，状态正确标记
3. ✅ **用户中止**: 执行中取消，状态标记为aborted
4. ✅ **工具错误**: 工具调用失败，错误被捕获
5. ✅ **长计划**: 10+步骤，所有状态正确

### 验证点
```bash
# 查看日志确认
- 每个步骤都有 ⏳ 开始日志
- 每个步骤都有 📊 状态转换日志
- 每个步骤都有 ✅ 完成 或 ❌ 失败 日志
- 每个步骤都有 📈 进度更新日志
- 没有未完成就跳到下一步的情况
```

## 核心原则

**状态管理完全由系统控制，AI只负责执行业务逻辑，不参与进度管理。**

这样的架构保证了:
1. 状态更新的一致性和可靠性
2. 易于调试和追踪
3. 避免AI的不确定性影响状态管理
4. 清晰的职责分离

## 监控日志

改进后的日志使用emoji标识，易于快速查找问题：

- ⏳ 步骤开始
- 📊 状态转换  
- ⏰ 时间继承
- ✅ 成功完成
- ❌ 执行失败
- ⚠️ 异常警告
- 🛑 用户中止
- 💥 未预期错误
- 📈 进度更新

所有日志都带有 `[Plan]` 前缀，可以用以下命令查看：

```bash
# 查看所有计划执行日志
grep "\[Plan\]" logs/*.log

# 查看失败步骤
grep "\[Plan\].*❌" logs/*.log

# 查看状态转换
grep "\[Plan\].*📊" logs/*.log
```
