## 现状定位
- 计划步骤状态由服务端写入 data-plan-progress（见 [route.ts](file:///e:/codex/src/app/api/chat/route.ts#L400-L448)、[shared.chat.ts](file:///e:/codex/src/app/api/chat/shared.chat.ts#L442-L541)），前端通过聚合渲染（见 [plan-message-part.tsx](file:///e:/codex/src/components/plan-message-part.tsx#L30-L46)、[message.tsx](file:///e:/codex/src/components/message.tsx#L46-L62)）。
- [progress-tracker.ts](file:///e:/codex/src/lib/ai/plan/progress-tracker.ts) 同时承担：显式 progress 处理、自动推断、输出归属、埋点与流写入。

## 关键问题（步骤状态显示错误）
- progress-tracker 里用 isExplicitProgress 试图“显式优先”，但它在非 progress 工具输入时被重置为 false（[progress-tracker.ts](file:///e:/codex/src/lib/ai/plan/progress-tracker.ts#L105-L112)）。
- 结果：当模型按提示词正确调用 progress(in_progress) 后再调用实际工具时，工具输出阶段会被当成“无显式 progress”路径，触发 autoCompleteStep，把步骤提前标记为 completed/failed（[progress-tracker.ts](file:///e:/codex/src/lib/ai/plan/progress-tracker.ts#L145-L149)）。
- 这会导致 UI 出现“步骤提前完成/跳步/耗时异常”等状态显示错误。

## 代码优化与职责单一（progress-tracker.ts）
1. 把显式模式做成“会话级/计划级开关”
   - 将 isExplicitProgress 改为显式模式标记（例如 isExplicitMode），一旦检测到 progress 工具调用即开启，直到 activePlanId 切换或显式 reset。
   - 显式模式开启时：禁用 autoStartStep/autoCompleteStep，仅做“工具名归属/输出归属”辅助。
2. 修正显式 progress 的健壮性
   - applyExplicitProgress 支持 steps 自动扩容（与 [shared.chat.ts](file:///e:/codex/src/app/api/chat/shared.chat.ts#L487-L499) 一致），避免 progress 先到但快照尚未初始化时丢更新。
   - 同步写入 actions（当前 applyExplicitProgress 未写 actions，会导致 UI 标签缺失）。
   - failed 的 errorMessage 从 actions 中提取更可靠（优先找 label=error 的 value，否则回退到第一个 value）。
   - 修正 recordStepFailed 埋点取值使用旧 step.errorMessage 的问题。
3. 单一职责拆分（不引入新模块也能达成）
   - 用更小的私有函数拆开：ensureStep、updateStep、appendToolCall、selectOutputStepIndex。
   - 删除或落地无用状态（stepIndexForOutput/lastStartedStepIndex），改为明确的 activeStepIndex（由 progress(in_progress) 决定）用于输出归属。
4. 命名优化
   - 将公开方法 handleToolInput/handleToolOutput 改为动词+名词（例如 trackToolInput/trackToolOutput），并同步更新 [route.ts](file:///e:/codex/src/app/api/chat/route.ts#L542-L567) 调用点。

## plan 提示词优化（plan-prompts.ts）
- 强化 planId 规则：必须使用对应 toolCallId（Outline/Plan 的 toolCallId），不要拼 title。
- 强化 progress 失败语义：失败时必须带 actions: [{label:"error", value:"原因"}]，保证 UI 的错误信息稳定。
- 强化步骤边界：每步仅允许一个“in_progress → completed/failed”闭环；多工具调用也必须在同一步闭环内完成。

## progress 工具说明优化（tools/planning/progress.ts）
- 更新 planId 字段描述：允许来自 plan 或 outline 的 toolCallId（与实际执行链路一致）。

## 验证（新增 vitest 单测）
- 新增 progress-tracker 的单测覆盖：
  - 显式模式下，工具输出不应触发 autoComplete（复现并锁定本次“步骤状态显示错误”）。
  - progress 先到且 steps 为空时，applyExplicitProgress 能扩容并正确落状态与 actions。
  - 工具调用名与 step output 归属到当前显式 in_progress step。

## 交付结果
- 修复步骤状态显示错误（显式 progress 场景不再被自动完成逻辑干扰）。
- progress-tracker 更易读、更少副作用与冗余状态，职责更清晰。
- 提示词与工具 schema 描述一致，降低模型误用 planId 与错误信息缺失概率。